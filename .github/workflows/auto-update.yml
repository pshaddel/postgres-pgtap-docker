name: Auto Update PostgreSQL Versions

on:
  schedule:
    # Run one a monthly at 2:00 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-postgres-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use PAT if GITHUB_TOKEN doesn't have sufficient permissions
          # token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Check for new PostgreSQL versions
        id: check
        run: |
          # Get latest PostgreSQL versions from Docker Hub API
          LATEST_18=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/postgres/tags/?page_size=100" | \
            jq -r '.results[].name' | \
            grep -E '^18\.[0-9]+(\.[0-9]+)*$' | \
            sort -V | tail -1)

          LATEST_17=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/postgres/tags/?page_size=100" | \
            jq -r '.results[].name' | \
            grep -E '^17\.[0-9]+(\.[0-9]+)*$' | \
            sort -V | tail -1)

          # Get current versions from build script
          CURRENT_18=$(grep -A1 '\["18"\]=' build-all-versions.sh | grep -o '[0-9]\+\.[0-9]\+' | head -1)
          CURRENT_17=$(grep -A1 '\["17"\]=' build-all-versions.sh | grep -o '[0-9]\+\.[0-9]\+' | head -1 || echo "")

          echo "Latest PostgreSQL 18 version: $LATEST_18"
          echo "Current PostgreSQL 18 version in script: $CURRENT_18"
          echo "Latest PostgreSQL 17 version: $LATEST_17"
          echo "Current PostgreSQL 17 version in script: $CURRENT_17"

          NEEDS_UPDATE=false

          if [ "$LATEST_18" != "$CURRENT_18" ]; then
            echo "postgres_18_update=true" >> $GITHUB_OUTPUT
            echo "new_version_18=$LATEST_18" >> $GITHUB_OUTPUT
            NEEDS_UPDATE=true
          else
            echo "postgres_18_update=false" >> $GITHUB_OUTPUT
          fi

          if [ "$LATEST_17" != "$CURRENT_17" ] && [ -n "$CURRENT_17" ]; then
            echo "postgres_17_update=true" >> $GITHUB_OUTPUT
            echo "new_version_17=$LATEST_17" >> $GITHUB_OUTPUT
            NEEDS_UPDATE=true
          else
            echo "postgres_17_update=false" >> $GITHUB_OUTPUT
          fi

          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT

      - name: Update build script
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Update PostgreSQL 18 version if needed
          if [ "${{ steps.check.outputs.postgres_18_update }}" = "true" ]; then
            NEW_VERSION_18="${{ steps.check.outputs.new_version_18 }}"
            MAJOR_18=$(echo $NEW_VERSION_18 | cut -d. -f1)

            # Update the PostgreSQL 18 version tags in build script
            sed -i "s/\[\"18\"\]=\"[^\"]*\"/[\"18\"]=\"$NEW_VERSION_18 18 latest ${NEW_VERSION_18}-trixie 18-trixie trixie ${NEW_VERSION_18}-bookworm 18-bookworm bookworm \"/" build-all-versions.sh
          fi

          # Update PostgreSQL 17 version if needed
          if [ "${{ steps.check.outputs.postgres_17_update }}" = "true" ]; then
            NEW_VERSION_17="${{ steps.check.outputs.new_version_17 }}"

            # Uncomment and update PostgreSQL 17 line
            sed -i 's/^[[:space:]]*# \[\["17"\]\]/    ["17"]/' build-all-versions.sh
            sed -i "s/\[\"17\"\]=\"[^\"]*\"/[\"17\"]=\"$NEW_VERSION_17 17 ${NEW_VERSION_17}-trixie 17-trixie ${NEW_VERSION_17}-bookworm 17-bookworm\"/" build-all-versions.sh
          fi

      - name: Check if images need building
        if: steps.check.outputs.needs_update == 'true'
        id: check_images
        run: |
          # Log in to Docker Hub first to access the registry
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

          # Make build script executable
          chmod +x build-all-versions.sh

          # Create a test script to check if any images need building
          cat > check_images.sh << 'EOF'
          #!/bin/bash

          # Source the versions from build script
          source build-all-versions.sh

          # Function to check if Docker image already exists
          image_exists() {
              local image_tag=$1
              if docker manifest inspect "pshaddel/postgres-pgtap:$image_tag" >/dev/null 2>&1; then
                  return 0
              else
                  return 1
              fi
          }

          # Check if any version needs building
          needs_any_building=false
          for version in "${!POSTGRES_VERSIONS[@]}"; do
              tags="${POSTGRES_VERSIONS[$version]}"
              for tag in $tags; do
                  if ! image_exists "$tag"; then
                      echo "Image pshaddel/postgres-pgtap:$tag does not exist, building needed"
                      needs_any_building=true
                      break 2
                  fi
              done
          done

          if [ "$needs_any_building" = true ]; then
              echo "needs_building=true" >> $GITHUB_OUTPUT
          else
              echo "needs_building=false" >> $GITHUB_OUTPUT
              echo "All images already exist, no building needed"
          fi
          EOF

          chmod +x check_images.sh
          ./check_images.sh

      - name: Set up Docker Buildx
        if: steps.check.outputs.needs_update == 'true' && steps.check_images.outputs.needs_building == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.check.outputs.needs_update == 'true' && steps.check_images.outputs.needs_building == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push multi-platform images
        if: steps.check.outputs.needs_update == 'true' && steps.check_images.outputs.needs_building == 'true'
        run: |
          # Make build script executable and run it
          chmod +x build-all-versions.sh
          ./build-all-versions.sh

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          # Use PAT if GITHUB_TOKEN doesn't have sufficient permissions
          # token: ${{ secrets.PAT_TOKEN }}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-update PostgreSQL versions"
          title: "Auto-update PostgreSQL versions"
          body: |
            This PR automatically updates PostgreSQL versions to the latest available.

            Updates:
            ${{ steps.check.outputs.postgres_18_update == 'true' && format('- Updated PostgreSQL 18 to {0}', steps.check.outputs.new_version_18) || '' }}
            ${{ steps.check.outputs.postgres_17_update == 'true' && format('- Updated PostgreSQL 17 to {0}', steps.check.outputs.new_version_17) || '' }}

            Build status:
            ${{ steps.check_images.outputs.needs_building == 'true' && '- Docker images were rebuilt and pushed' || '- No image rebuilding was needed (all images already exist)' }}

            The build script handles:
            - Multi-platform builds (linux/arm/v7, linux/arm64/v8, linux/amd64)
            - PostgreSQL 18 special handling (copying pgTAP from PG17)
            - All variant tags (bookworm, trixie)
            - Skipping builds for images that already exist
          branch: auto-update-postgres-versions